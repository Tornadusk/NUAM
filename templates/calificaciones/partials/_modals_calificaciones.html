<!-- Modal Ingresar Calificación -->
<div class="modal fade" id="modalIngresar" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ingresar Calificación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <ul class="nav nav-tabs mb-3" id="wizardTabs">
                    <li class="nav-item">
                        <a class="nav-link active" data-step="1" 
                           data-bs-toggle="tooltip" 
                           data-bs-placement="top" 
                           title="Ingrese la información básica de la calificación: Corredora, Instrumento, Fuente, Moneda, Año y Fecha de Pago">
                            <span class="badge bg-primary me-2">1</span> Datos Básicos
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-step="2" 
                           data-bs-toggle="tooltip" 
                           data-bs-placement="top" 
                           title="Ingrese los factores tributarios (F08-F37) como valores decimales. Use punto para decimales (ej: 0.0125 = 1.25%). La suma total no debe exceder 1. Puede dejar campos vacíos si no aplican.">
                            <span class="badge bg-secondary me-2">2</span> Factores (F08-F37)
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-step="3" 
                           data-bs-toggle="tooltip" 
                           data-bs-placement="top" 
                           title="Revise el resumen de los datos ingresados antes de guardar. Verifique que la suma de factores sea correcta.">
                            <span class="badge bg-secondary me-2">3</span> Confirmar
                        </a>
                    </li>
                </ul>
                
                <!-- Step 1: Datos Básicos -->
                <div class="wizard-step" data-step="1">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Corredora *</label>
                            <select class="form-select" id="formCorredora" required>
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Instrumento *</label>
                            <select class="form-select" id="formInstrumento" required>
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Fuente *</label>
                            <select class="form-select" id="formFuente" required>
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Moneda *</label>
                            <select class="form-select" id="formMoneda" required>
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Año *</label>
                            <input type="number" class="form-control" id="formEjercicio" required min="2000" max="2100">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Fecha de Pago *</label>
                            <input type="date" class="form-control" id="formFechaPago" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Secuencia Evento *</label>
                            <input type="text" class="form-control" id="formSecuenciaEvento" required placeholder="Ej: 00001">
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Descripción</label>
                            <input type="text" class="form-control" id="formDescripcion">
                        </div>
                    </div>
                    <div class="mt-3 text-end">
                        <button type="button" class="btn btn-primary" onclick="nextWizardStep()">
                            Siguiente <i class="fas fa-arrow-right ms-1"></i>
                        </button>
                    </div>
                </div>

                <!-- Step 2: Factores -->
                <div class="wizard-step" data-step="2" style="display: none;">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Ingrese los factores (F08-F37). La suma no debe exceder 1.
                    </div>
                    <div class="row g-2" id="factoresContainer">
                        <!-- Se generará dinámicamente -->
                    </div>
                    <div class="mt-3 d-flex justify-content-between">
                        <button type="button" class="btn btn-secondary" onclick="prevWizardStep()">
                            <i class="fas fa-arrow-left me-1"></i> Anterior
                        </button>
                        <button type="button" class="btn btn-primary" onclick="nextWizardStep()">
                            Siguiente <i class="fas fa-arrow-right ms-1"></i>
                        </button>
                    </div>
                </div>

                <!-- Step 3: Confirmar -->
                <div class="wizard-step" data-step="3" style="display: none;">
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>
                        Los datos están listos para ser guardados.
                    </div>
                    <div id="resumenDatos">
                        <!-- Se mostrará resumen -->
                    </div>
                    <div class="mt-3 d-flex justify-content-between">
                        <button type="button" class="btn btn-secondary" onclick="prevWizardStep()">
                            <i class="fas fa-arrow-left me-1"></i> Anterior
                        </button>
                        <button type="button" class="btn btn-success" onclick="guardarCalificacion()">
                            <i class="fas fa-save me-1"></i> Grabar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Modificar Calificación -->
<div class="modal fade" id="modalModificar" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Modificar Calificación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <ul class="nav nav-tabs mb-3" id="wizardTabsEditar">
                    <li class="nav-item">
                        <a class="nav-link active" data-step="1">
                            <span class="badge bg-primary me-2">1</span> Datos Básicos
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-step="2">
                            <span class="badge bg-secondary me-2">2</span> Factores (F08-F37)
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-step="3">
                            <span class="badge bg-secondary me-2">3</span> Confirmar
                        </a>
                    </li>
                </ul>
                
                <!-- Step 1: Datos Básicos -->
                <div class="wizard-step" data-step="1">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Corredora *</label>
                            <select class="form-select" id="editarFormCorredora" required>
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Instrumento *</label>
                            <select class="form-select" id="editarFormInstrumento" required>
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Fuente *</label>
                            <select class="form-select" id="editarFormFuente" required>
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Moneda *</label>
                            <select class="form-select" id="editarFormMoneda" required>
                                <option value="">Seleccione...</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Año *</label>
                            <input type="number" class="form-control" id="editarFormEjercicio" required min="2000" max="2100">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Fecha de Pago *</label>
                            <input type="date" class="form-control" id="editarFormFechaPago" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Secuencia Evento *</label>
                            <input type="text" class="form-control" id="editarFormSecuenciaEvento" required placeholder="Ej: 00001">
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Descripción</label>
                            <input type="text" class="form-control" id="editarFormDescripcion">
                        </div>
                    </div>
                    <div class="mt-3 text-end">
                        <button type="button" class="btn btn-primary" onclick="nextWizardStepEditar()">
                            Siguiente <i class="fas fa-arrow-right ms-1"></i>
                        </button>
                    </div>
                </div>

                <!-- Step 2: Factores -->
                <div class="wizard-step" data-step="2" style="display: none;">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Modifique los factores (F08-F37). La suma no debe exceder 1.
                    </div>
                    <div class="row g-2" id="editarFactoresContainer">
                        <!-- Se generará dinámicamente -->
                    </div>
                    <div class="mt-3 d-flex justify-content-between">
                        <button type="button" class="btn btn-secondary" onclick="prevWizardStepEditar()">
                            <i class="fas fa-arrow-left me-1"></i> Anterior
                        </button>
                        <button type="button" class="btn btn-primary" onclick="nextWizardStepEditar()">
                            Siguiente <i class="fas fa-arrow-right ms-1"></i>
                        </button>
                    </div>
                </div>

                <!-- Step 3: Confirmar -->
                <div class="wizard-step" data-step="3" style="display: none;">
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>
                        Los datos están listos para ser guardados.
                    </div>
                    <div id="editarResumenDatos">
                        <!-- Se mostrará resumen -->
                    </div>
                    <div class="mt-3 d-flex justify-content-between">
                        <button type="button" class="btn btn-secondary" onclick="prevWizardStepEditar()">
                            <i class="fas fa-arrow-left me-1"></i> Anterior
                        </button>
                        <button type="button" class="btn btn-success" onclick="actualizarCalificacion()">
                            <i class="fas fa-save me-1"></i> Grabar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Preview Factores Calculados -->
<div class="modal fade" id="modalPreviewFactores" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="fas fa-calculator me-2"></i>
                    Preview de Factores Calculados
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Revise los factores calculados desde los montos antes de grabar. 
                    Los factores se calcularon usando la fórmula: <strong>Factor = Monto / Suma Total de Montos</strong>
                </div>
                
                <!-- Resumen -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title">Calificación ID</h6>
                                <p class="card-text fs-5 mb-0" id="previewCalificacionId">-</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title">Suma de Montos</h6>
                                <p class="card-text fs-5 mb-0" id="previewSumaMontos">-</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title">Suma de Factores</h6>
                                <p class="card-text fs-5 mb-0" id="previewSumaFactores">-</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tabla de Montos y Factores -->
                <div class="table-responsive" style="max-height: 400px;">
                    <table class="table table-bordered table-striped table-hover table-sm">
                        <thead class="table-dark sticky-top">
                            <tr>
                                <th>Código</th>
                                <th>Monto (M)</th>
                                <th>Factor (F)</th>
                                <th>% del Total</th>
                            </tr>
                        </thead>
                        <tbody id="previewFactoresTableBody">
                            <!-- Se llenará dinámicamente -->
                        </tbody>
                        <tfoot class="table-secondary">
                            <tr>
                                <th>Total</th>
                                <th id="previewTotalMontos">-</th>
                                <th id="previewTotalFactores">-</th>
                                <th id="previewTotalPorcentaje">-</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                <div class="alert alert-warning mt-3">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Advertencia:</strong> Al grabar, se sobrescribirán los factores actuales (si existen) con los factores calculados.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="limpiarPreviewFactores()">
                    <i class="fas fa-times me-1"></i> Cancelar
                </button>
                <button type="button" class="btn btn-success" id="btnGrabarFactores" onclick="grabarFactoresCalculados()">
                    <i class="fas fa-save me-1"></i> Grabar Factores
                </button>
            </div>
        </div>
    </div>
</div>

