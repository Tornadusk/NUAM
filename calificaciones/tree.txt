NUAM - Calificaciones App - Estructura de Archivos
=================================================================

ğŸ“ calificaciones/
â”‚
â”œâ”€â”€ ğŸ“„ __init__.py                 # App package marker
â”œâ”€â”€ ğŸ“„ apps.py                     # AppConfig: '02. Calificaciones'
â”œâ”€â”€ ğŸ“„ models.py                   # FactorDef, Calificacion, Detalles
â”œâ”€â”€ ğŸ“„ admin.py                    # ModelAdmin con acciones masivas
â”œâ”€â”€ ğŸ“„ views.py                    # mantenedor_calificaciones() + decorator @login_required
â”œâ”€â”€ ğŸ“„ urls.py                     # URL routing: /calificaciones/mantenedor/
â”‚
â””â”€â”€ ğŸ“ templates/
    â””â”€â”€ ğŸ“ calificaciones/
        â”œâ”€â”€ ğŸ“„ mantenedor.html     # â­ VISTA PRINCIPAL ÃšNICA (931 lÃ­neas)
        â”‚                          #    
        â”‚                          # ğŸ“ ESTRUCTURA:
        â”‚                          #    {% extends 'base.html' %}
        â”‚                          #    {% load static %}
        â”‚                          #    
        â”‚                          # ğŸ¨ CONTENIDO:
        â”‚                          #    â”œâ”€â”€ CSRF Token (oculto)
        â”‚                          #    â”œâ”€â”€ Page Header (tÃ­tulo + badge MVP)
        â”‚                          #    â”œâ”€â”€ Main Tabs (nav nav-tabs con 5 pestaÃ±as)
        â”‚                          #    â”‚   â”œâ”€â”€ Mantenedor (activo por defecto)
        â”‚                          #    â”‚   â”œâ”€â”€ Cargas Masivas
        â”‚                          #    â”‚   â”œâ”€â”€ Usuarios ({% if is_admin %})
        â”‚                          #    â”‚   â”œâ”€â”€ AuditorÃ­a ({% if is_admin %})
        â”‚                          #    â”‚   â””â”€â”€ Reportes
        â”‚                          #    â”‚
        â”‚                          #    â”œâ”€â”€ Tab Content (tab-content con 5 panes)
        â”‚                          #    â”‚   â”œâ”€â”€ #mantenedor: Filtros + Tabla + KPIs + AuditorÃ­a Reciente
        â”‚                          #    â”‚   â”œâ”€â”€ #cargas: 2 cards (Factor + Monto)
        â”‚                          #    â”‚   â”œâ”€â”€ #usuarios: Tabla usuarios (solo Admin)
        â”‚                          #    â”‚   â”œâ”€â”€ #auditoria: Tabla eventos (solo Admin)
        â”‚                          #    â”‚   â””â”€â”€ #reportes: 3 cards exportaciÃ³n
        â”‚                          #    â”‚
        â”‚                          #    â””â”€â”€ Modales:
        â”‚                          #        â”œâ”€â”€ #modalIngresar (wizard 3 pasos)
        â”‚                          #        â”œâ”€â”€ #modalModificar (wizard 3 pasos)
        â”‚                          #        â”œâ”€â”€ #modalCrearUsuario (solo Admin)
        â”‚                          #        â”œâ”€â”€ #modalEditarUsuario (solo Admin)
        â”‚                          #        â””â”€â”€ (placeholders para cargas)
        â”‚                          #
        â”‚                          # ğŸ”§ POR QUÃ‰ NO SE REFACTORIZÃ“:
        â”‚                          #    - Ya funciona correctamente
        â”‚                          #    - JS ya estÃ¡ modularizado (ES6 modules)
        â”‚                          #    - Refactorizar HTML puede romper algo sin beneficio inmediato
        â”‚                          #    - Prioridad: estabilidad y funcionalidad primero
        â”‚                          #    - Partials se puede hacer post-MVP si se necesita
        â”‚
        â””â”€â”€ ğŸ“ partials/           # ğŸ†• FUTURO (OPCIONAL): Partials por tab
            â””â”€â”€ (vacÃ­o por ahora)  #    
                                   # ğŸ“‹ ESTRUCTURA PROPUESTA:
                                   #    
                                   # â”œâ”€â”€ _mantenedor_tab.html        # Filtros + Tabla + KPIs
                                   # â”œâ”€â”€ _cargas_tab.html             # 2 cards carga Factor/Monto
                                   # â”œâ”€â”€ _usuarios_tab.html           # Tabla usuarios
                                   # â”œâ”€â”€ _auditoria_tab.html          # Tabla eventos
                                   # â”œâ”€â”€ _reportes_tab.html           # Cards exportaciÃ³n
                                   # â”‚
                                   # â”œâ”€â”€ _modal_ingresar.html         # Wizard ingreso
                                   # â”œâ”€â”€ _modal_modificar.html        # Wizard ediciÃ³n
                                   # â”œâ”€â”€ _modal_usuario.html          # Modal crear/editar
                                   # â””â”€â”€ _modal_cargas.html           # Modales carga masiva
                                   #
                                   # ğŸ’¡ USO EN mantenedor.html:
                                   #    {% include 'calificaciones/partials/_mantenedor_tab.html' %}
                                   #
                                   # âš ï¸ RAZÃ“N DE NO IMPLEMENTAR AHORA:
                                   #    - AÃ±ade complejidad sin beneficio inmediato
                                   #    - Ya funciona con JS modularizado
                                   #    - Mayor riesgo de errores al refactorizar
                                   #    - Mejor enfocarse en cargas masivas (prioridad)

ğŸ“ templates/static/js/mantenedor/
â”‚                                  # ğŸ§© MÃ“DULOS ES6 (refactorizado)
â”œâ”€â”€ ğŸ“„ init.js                     # âš¡ Orquesta imports, persiste tabs, exporta globales
â”œâ”€â”€ ğŸ“„ core.js                     # ğŸ”§ Utilidades: getCookie, fetchWithCSRF, populateSelect
â”œâ”€â”€ ğŸ“„ calificaciones.js           # ğŸ¯ CRUD + Wizard: abrirModalModificar, actualizarCalificacion
â”œâ”€â”€ ğŸ“„ cargas.js                   # ğŸ“¤ Cargas masivas (placeholder)
â”œâ”€â”€ ğŸ“„ usuarios.js                 # ğŸ‘¥ GestiÃ³n usuarios + roles
â”œâ”€â”€ ğŸ“„ auditoria.js                # ğŸ“‹ Feed eventos recientes
â”œâ”€â”€ ğŸ“„ reportes.js                 # ğŸ“Š CSV/Excel/PDF export
â”œâ”€â”€ ğŸ“„ README.txt                  # ğŸ“– Arquitectura de mÃ³dulos
â”œâ”€â”€ ğŸ“„ original_mantenedor_backup.txt  # ğŸ—„ï¸ Backup monolÃ­tico (1270 lÃ­neas)
â””â”€â”€ ğŸ“„ DIFERENCIA_STATIC.txt       # â„¹ï¸ ExplicaciÃ³n de static/ y staticfiles/

ğŸ”— FLUJO DE DATOS
=================

1. URLs (urls.py)
   â””â”€â”€ '/calificaciones/mantenedor/' â†’ views.mantenedor_calificaciones()

2. View (views.py)
   â””â”€â”€ Renderiza mantenedor.html + contexto is_admin

3. Template (mantenedor.html)
   â””â”€â”€ <script type="module" src="{% static 'js/mantenedor/init.js' %}"></script>

4. JS Init (init.js)
   â”œâ”€â”€ Importa: calificaciones.js, cargas.js, usuarios.js, auditoria.js, reportes.js
   â”œâ”€â”€ DOMContentLoaded â†’ cargarCatalogos(), cargarCalificaciones(), etc.
   â””â”€â”€ Exporta funciones globales â†’ onclick="abrirModalIngresar()"

5. MÃ³dulos JS
   â”œâ”€â”€ calificaciones.js â†’ CRUD completo + wizard + modales
   â”œâ”€â”€ cargas.js â†’ Carga x Factor/Monto (pendiente)
   â”œâ”€â”€ usuarios.js â†’ CRUD usuarios + colaboradores
   â”œâ”€â”€ auditoria.js â†’ Feed eventos recientes
   â””â”€â”€ reportes.js â†’ ExportaciÃ³n CSV/Excel/PDF

6. API REST (/api/)
   â””â”€â”€ CalificacionViewSet â†’ GET, POST, PUT, DELETE con autenticaciÃ³n

ğŸ¯ FUNCIONALIDADES POR TAB
===========================

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TAB 1: MANTENEDOR                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… Filtros (Mercado, Origen, PerÃ­odo)                   â”‚
â”‚ âœ… Tabla con paginaciÃ³n (10 por pÃ¡gina)                 â”‚
â”‚ âœ… CRUD completo:                                        â”‚
â”‚    âœ… Ingresar (wizard 3 pasos)                         â”‚
â”‚    âœ… Modificar (wizard 3 pasos con datos precargados)  â”‚
â”‚    âœ… Eliminar (con confirmaciÃ³n)                       â”‚
â”‚    âœ… Copiar (duplicar calificaciÃ³n)                    â”‚
â”‚ âœ… ValidaciÃ³n suma factores â‰¤ 1                         â”‚
â”‚ âœ… Tooltips informativos en wizard                      â”‚
â”‚ âœ… Campos requeridos con asterisco (*)                  â”‚
â”‚ âœ… KPIs y AuditorÃ­a Reciente                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TAB 2: CARGAS MASIVAS                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â³ Carga x Factor (en desarrollo)                       â”‚
â”‚ â³ Carga x Monto (en desarrollo)                        â”‚
â”‚ ğŸ”§ Placeholder UI con formularios bÃ¡sicos               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TAB 3: USUARIOS (Solo Admin)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… Tabla usuarios con datos completos                   â”‚
â”‚ âœ… Crear usuario (wizard persona + usuario + roles)     â”‚
â”‚ âœ… Editar usuario (modal precargado)                    â”‚
â”‚ âœ… Eliminar usuario (con confirmaciÃ³n)                  â”‚
â”‚ âœ… SincronizaciÃ³n con Django User                       â”‚
â”‚ âœ… ValidaciÃ³n email, contraseÃ±as coinciden             â”‚
â”‚ âœ… Toggle mostrar/ocultar contraseÃ±a                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TAB 4: AUDITORÃA (Solo Admin)                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… Tabla eventos recientes                              â”‚
â”‚ âœ… Feed automÃ¡tico desde /api/auditoria/                â”‚
â”‚ âœ… Campos: Fecha, Usuario, AcciÃ³n, Entidad, ID          â”‚
â”‚ â³ AuditorÃ­a completa (pendiente filtros avanzados)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TAB 5: REPORTES                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… Exportar CSV (funcional)                             â”‚
â”‚ âœ… Exportar Excel (placeholder)                         â”‚
â”‚ âœ… Exportar PDF (placeholder)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ” SEGURIDAD
============

- CSRF Token en todos los POST/PUT/DELETE
- @login_required en vista Django
- is_admin context variable para ocultar tabs Admin
- fetchWithCSRF() helper para incluir token automÃ¡ticamente
- Permisos backend: IsAuthenticatedOrReadOnly en DRF

ğŸ“Š MODELOS (models.py)
======================

FactorDef
â”œâ”€â”€ id_factor (PK)
â”œâ”€â”€ codigo_factor (F08, F09, ... F37)
â”œâ”€â”€ nombre_corto
â”œâ”€â”€ descripcion
â”œâ”€â”€ tipo_valor (factor, monto, tasa)
â”œâ”€â”€ orden_visual
â”œâ”€â”€ aplica_en_suma (boolean)
â”œâ”€â”€ requerido (boolean) ğŸ†•
â””â”€â”€ vigencia (desde/hasta)

Calificacion
â”œâ”€â”€ id_calificacion (PK)
â”œâ”€â”€ id_corredora (FK â†’ corredora)
â”œâ”€â”€ id_instrumento (FK â†’ instrumento)
â”œâ”€â”€ id_fuente (FK â†’ fuente)
â”œâ”€â”€ id_evento (FK â†’ evento_capital, opcional)
â”œâ”€â”€ ejercicio (int)
â”œâ”€â”€ fecha_pago (date)
â”œâ”€â”€ secuencia_evento (varchar)
â”œâ”€â”€ estado (borrador/validada/publicada/pendiente) â†’ DEFAULT 'borrador'
â”œâ”€â”€ factor_actualizacion, valor_historico
â”œâ”€â”€ ingreso_por_montos, acogido_sfut
â”œâ”€â”€ observaciones
â”œâ”€â”€ id_moneda (FK â†’ moneda)
â”œâ”€â”€ creado_por, actualizado_por (FK â†’ usuario) ğŸ†•
â””â”€â”€ timestamps

CalificacionFactorDetalle
â”œâ”€â”€ id (PK auto)
â”œâ”€â”€ id_calificacion (FK)
â”œâ”€â”€ id_factor (FK â†’ factor_def)
â”œâ”€â”€ valor_factor (decimal 20,8)
â””â”€â”€ timestamps

CalificacionMontoDetalle
â”œâ”€â”€ id (PK auto)
â”œâ”€â”€ id_calificacion (FK)
â”œâ”€â”€ id_factor (FK â†’ factor_def)
â”œâ”€â”€ valor_monto (decimal 20,8)
â””â”€â”€ timestamps

ğŸš€ ORDEN DE DESARROLLO RECOMENDADO
===================================

âœ… PHASE 1: CORE (COMPLETADO)
  âœ… Modelos, Admin, API, Auth
  âœ… Wizard ingreso de calificaciones
  âœ… CRUD bÃ¡sico (Create, Read, Update, Delete)
  âœ… Validaciones frontend + backend
  âœ… ModularizaciÃ³n JS (ES6 modules)

ğŸ”¨ PHASE 2: EN PROGRESO
  âœ… Modificar CalificaciÃ³n
  â³ Cargas Masivas x Factor
  â³ Cargas Masivas x Monto

ğŸ“‹ PHASE 3: PENDIENTE
  â³ Filtros avanzados en API
  â³ AuditorÃ­a completa con filtros
  â³ Reportes reales (actualizar PDF/Excel)
  â³ CÃ¡lculo automÃ¡tico de factores desde montos (HU-08)
  â³ BotÃ³n "Calcular" en wizard

ğŸ”® FUTURO (Post-MVP)
  ğŸ“¦ Partials HTML (_mantenedor.html, etc.)
  ğŸ“¦ OptimizaciÃ³n de queries con select_related/prefetch_related
  ğŸ“¦ CachÃ© de catÃ¡logos
  ğŸ“¦ WebSockets para auditorÃ­a en tiempo real
  ğŸ“¦ ExportaciÃ³n de reportes en background

ğŸ”— DEPENDENCIAS ENTRE MÃ“DULOS
==============================

calificaciones.js
  â””â”€â”€â†’ core.js (API_BASE_URL, fetchWithCSRF, populateSelect)
       â””â”€â”€â†’ reportes.js (setCalificacionesData)
            â””â”€â”€â†’ calificacionesData (export let)

usuarios.js
  â””â”€â”€â†’ core.js (API_BASE_URL, fetchWithCSRF)

auditoria.js
  â””â”€â”€â†’ core.js (API_BASE_URL)

reportes.js
  â””â”€â”€â†’ core.js (API_BASE_URL, downloadBlob)

cargas.js
  â””â”€â”€â†’ core.js (API_BASE_URL) â³

init.js
  â””â”€â”€â†’ Todos los mÃ³dulos
       â””â”€â”€â†’ Exporta funciones globales para onclick

ğŸ’¡ PATRÃ“N DE NOMENCLATURA
==========================

IDs de elementos HTML:
- formCorredora, formInstrumento â†’ Modal INGRESAR
- editarFormCorredora, editarFormInstrumento â†’ Modal MODIFICAR
- crearUsername, crearPassword â†’ Modal CREAR USUARIO
- filtroMercado, filtroOrigen â†’ Filtros del mantenedor

Funciones globales:
- abrirModalIngresar() â†’ Acceso desde onclick HTML
- abrirModalModificar() â†’ Acceso desde onclick HTML
- guardarCalificacion() â†’ Acceso desde onclick HTML
- actualizarCalificacion() â†’ Acceso desde onclick HTML

MÃ³dulos JS:
- Exportar funciones â†’ export function nombreFuncion()
- Importar en init.js â†’ import { nombreFuncion } from './mÃ³dulo.js'
- Exponer globalmente â†’ window.nombreFuncion = MÃ³dulo.nombreFuncion

ğŸ“ NOTAS IMPORTANTES
====================

1. **staticfiles/**: Carpeta generada por collectstatic, NO editar manualmente
2. **templates/static/**: Fuente de archivos JS/CSS, aquÃ­ sÃ­ editar
3. **Wizard de ediciÃ³n**: Mismo flujo que ingreso, pero con datos precargados
4. **Estados**: borrador es el default, cambiar desde Admin o API
5. **Factores**: Solo se guardan si tienen valor > 0
6. **ValidaciÃ³n**: Suma solo factores con aplica_en_suma=true
7. **Persistencia de tabs**: localStorage con key por usuario

ğŸ¯ PRÃ“XIMOS PASOS
=================

1. âœ… Probar funcionalidad de Modificar CalificaciÃ³n
2. â³ Implementar Carga x Factor (HU-011, HU-013)
3. â³ Implementar Carga x Monto (HU-012, HU-013)
4. ğŸ“‹ Documentar API con Swagger/OpenAPI

=================================================================
Ãšltima actualizaciÃ³n: ImplementaciÃ³n de Modificar CalificaciÃ³n
=================================================================

